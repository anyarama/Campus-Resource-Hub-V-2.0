name: Tests and Quality Gates

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/tests.yml'
      - 'pyproject.toml'
      - 'pytest.ini'
      - '.pre-commit-config.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/tests.yml'
      - 'pyproject.toml'
      - 'pytest.ini'
      - '.pre-commit-config.yaml'
  workflow_dispatch:  # Allow manual trigger

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.9'
  POETRY_VERSION: '1.7.0'

jobs:
  # ==============================================================================
  # Code Quality Checks
  # ==============================================================================
  code-quality:
    name: Code Quality (Black, Ruff, Mypy)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r backend/requirements.txt
          pip install black ruff mypy types-Flask types-requests
      
      - name: Run Black (Code Formatter Check)
        run: |
          echo "::group::Black Code Formatter"
          cd backend
          black --check --diff --color --line-length 100 .
          echo "::endgroup::"
      
      - name: Run Ruff (Linter)
        run: |
          echo "::group::Ruff Linter"
          cd backend
          ruff check . --output-format=github
          echo "::endgroup::"
      
      - name: Run Mypy (Type Checker)
        run: |
          echo "::group::Mypy Type Checker"
          cd backend
          mypy . --ignore-missing-imports --show-error-codes || true
          echo "::endgroup::"
        continue-on-error: true  # Don't fail on mypy errors yet

  # ==============================================================================
  # Security Tests (High Priority)
  # ==============================================================================
  security-tests:
    name: Security Tests (95% Coverage Required)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Run Security Tests
        run: |
          cd backend
          pytest tests/security/ \
            -v \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=html:htmlcov/security \
            --cov-report=xml:coverage-security.xml \
            --cov-fail-under=95 \
            --tb=short \
            -m security
        env:
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///test.db
      
      - name: Upload Security Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-coverage-report
          path: backend/htmlcov/security
          retention-days: 30
      
      - name: Upload Security Coverage XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-coverage-xml
          path: backend/coverage-security.xml
          retention-days: 30

  # ==============================================================================
  # API Tests
  # ==============================================================================
  api-tests:
    name: API Tests (All Endpoints)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Run API Tests
        run: |
          cd backend
          pytest tests/api/ \
            -v \
            --cov=routes \
            --cov=services \
            --cov-report=term-missing \
            --cov-report=html:htmlcov/api \
            --cov-report=xml:coverage-api.xml \
            --tb=short \
            -m api
        env:
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///test.db
      
      - name: Upload API Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-coverage-report
          path: backend/htmlcov/api
          retention-days: 30
      
      - name: Upload API Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-coverage-xml
          path: backend/coverage-api.xml
          retention-days: 30

  # ==============================================================================
  # Integration Tests
  # ==============================================================================
  integration-tests:
    name: Integration Tests (User Workflows)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Run Integration Tests
        run: |
          cd backend
          pytest tests/integration/ \
            -v \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=html:htmlcov/integration \
            --cov-report=xml:coverage-integration.xml \
            --tb=short \
            -m integration
        env:
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///test.db
      
      - name: Upload Integration Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-coverage-report
          path: backend/htmlcov/integration
          retention-days: 30
      
      - name: Upload Integration Coverage XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-coverage-xml
          path: backend/coverage-integration.xml
          retention-days: 30

  # ==============================================================================
  # Combined Coverage Report (85% Threshold)
  # ==============================================================================
  combined-coverage:
    name: Combined Coverage Report (85% Required)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [security-tests, api-tests, integration-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Run All Tests with Combined Coverage
        run: |
          cd backend
          pytest tests/ \
            -v \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=html:htmlcov/combined \
            --cov-report=xml:coverage-combined.xml \
            --cov-fail-under=85 \
            --tb=short
        env:
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///test.db
      
      - name: Generate Coverage Badge
        run: |
          cd backend
          pip install coverage-badge
          coverage-badge -o coverage.svg -f
      
      - name: Upload Combined Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: combined-coverage-report
          path: backend/htmlcov/combined
          retention-days: 30
      
      - name: Upload Combined Coverage XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: combined-coverage-xml
          path: backend/coverage-combined.xml
          retention-days: 30
      
      - name: Upload Coverage Badge
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-badge
          path: backend/coverage.svg
          retention-days: 30
      
      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          COVERAGE_PATH: backend/coverage-combined.xml

  # ==============================================================================
  # Test Summary
  # ==============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-tests, api-tests, integration-tests, combined-coverage]
    if: always()
    
    steps:
      - name: Generate Test Summary
        run: |
          echo "# Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quality Gates Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tests (95%) | ${{ needs.security-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.api-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Combined Coverage (85%) | ${{ needs.combined-coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download coverage reports from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
      
      - name: Check Overall Status
        if: |
          needs.code-quality.result != 'success' ||
          needs.security-tests.result != 'success' ||
          needs.api-tests.result != 'success' ||
          needs.integration-tests.result != 'success' ||
          needs.combined-coverage.result != 'success'
        run: |
          echo "::error::One or more quality gates failed!"
          exit 1

# ==============================================================================
# Notification on Failure
# ==============================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: failure() && github.event_name == 'push'
    
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI Failure: ${context.workflow} on ${context.ref}`,
              body: `## CI Pipeline Failed\n\n` +
                    `**Workflow:** ${context.workflow}\n` +
                    `**Branch:** ${context.ref}\n` +
                    `**Commit:** ${context.sha}\n` +
                    `**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
                    `Please review the failed checks and fix the issues.`,
              labels: ['ci-failure', 'bug']
            });
